---
title: "Univariate examples"
author: "Eric Ward"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Univariate examples}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Installation

```{r install, eval=TRUE, warning=FALSE, message=FALSE, results='hide'}
library(predRecruit)
library(ggplot2)
```

## Parametric and semi-parametric examples

We can fit linear regression and generalized additive models using the `univariate()` function. Here, we'll simulate some dummy data. Our response has 40 time steps, and the matrix of predictors includes 4 potential covariates. 

```{r results = 'hide', message = FALSE, warning = FALSE}
set.seed(123)
response <- data.frame(time = 1:40, dev = rnorm(40))
predictors <- matrix(rnorm(4 * 40), ncol = 4)
predictors <- as.data.frame(predictors)
predictors$time <- 1:40

lm_example <- univariate_forecast(response,
  predictors,
  model_type = "lm", # can be 'lm' or 'gam'
  n_forecast = 10, # how many years of data to use in testing
  n_years_ahead = 1, # how many time steps ahead to forecast
  max_vars = 3) # maximum number of covars allowed in any one model
```

The returned object is a list with 4 elements

```{r}
names(lm_example)
```

These elements include
* pred, a dataframe consisting of our original data, with responses and covariates binded together. Also includes model predictions `.pred`, the fold id `id`, the permutation of covariate combinations `i`, and `type` indicating whether the prediction is made for the training or test set. 

* summary, a dataframe containing the fold id `id`, metrics of R-squared and RMSE (label in `.metric`, value in `.estimate`, the permutation of covariate combinations `i`, and `type` indicating whether the prediction is made for the training or test set). These values are calculated on each fold -- so if 1-step ahead forecasts are used, R-squared will be `NA` because each fold's prediction will be correlated with 1 observation in the test set (and a correlation can't be calculated for a single pair of values)  

```{r}
lm_example$summary
```

* covariate_combos, a dataframe containing all permutations of the covariates (rows correspond to values of `i` above)

* marginal_effects, a dataframe containing all marginal effects estimated with ggeffects

```{r}
marg <- lm_example$marginal_effects
marg
```

This dataframe contains all marginal effects for all folds (10 above). Let's first look at the predictions for just the first covariate combination. The column `var_fold` represents a unique combination of each covariate and fold. This plot represents the variability in marginal effects across folds,

```{r}
marg <- dplyr::filter(marg, i==1)

ggplot(marg, aes(x, predicted, group = var_fold)) + 
  geom_line() + 
  facet_wrap(~ cov_name) + 
  xlab("Covariate value") + 
  ylab("Predicted") + 
  theme_bw()
```

Similarly, we could add uncertainty from each fold using `geom_ribbon()`. The standard errors and confidence intervals are also stored in the returned dataframe, 

```{r}
marg$std.error # standard error
marg$conf.low # lower 95% CI
marg$conf.high # upper 95% CI
```

## Non-parametric examples

Using our above dummy dataset, we can also try to use random forest or lasso / ridge regression methods to generate forecasts. These are done with the `univariate_forecast_ml` function.   

```{r results = 'hide', message = FALSE, warning = FALSE}
lm_example <- univariate_forecast_ml(response,
    predictors,
    model_type = "glmnet", # can be "glmnet" or "randomForest"
    n_forecast = 10,
    n_years_ahead = 1)
```

The main difference between the parametric or semi-parametric approaches and the non-parametric ones are that we are not generating marginal effects. Similarly, the fitted object is slightly different -- this only includes 2 elements, 
* pred, a dataframe containing the original data (responses and predictors) along with estimated deviations
* tuning, a dataframe containing the tuning parameters that were explored for each row (`id`) 
